<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Minesweeper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg:#050816;
      --bg2:#0b1220;
      --card:rgba(15,23,42,.96);
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.16);
      --accent-2:#f97316;
      --accent-3:#22c55e;
      --bright:#e5e7eb;
      --muted:#9ca3af;
      --danger:#fb7185;
      --gold:#facc15;
      --shadow:0 24px 60px rgba(0,0,0,.7);
      --radius:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top,#0f172a 0,#020617 55%,#000 100%);
      color:var(--bright);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
    }
    .game-shell{
      width:100%;
      max-width:960px;
      background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.92));
      border-radius:24px;
      padding:14px 14px 18px;
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.45);
      position:relative;
      overflow:hidden;
    }
    .game-shell::before{
      content:"";
      position:absolute;
      inset:-120px;
      background:
        radial-gradient(circle at 0% 0%,rgba(56,189,248,.12),transparent 55%),
        radial-gradient(circle at 100% 0%,rgba(249,115,22,.12),transparent 55%);
      pointer-events:none;
      opacity:.7;
    }
    .content{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns:minmax(0,1.4fr) minmax(0,1fr);
      gap:14px;
    }
    @media (max-width:780px){
      .content{ grid-template-columns:1fr; }
    }
    .left, .right{min-width:0;}
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .title-block{ display:flex; flex-direction:column; gap:2px; }
    .title{
      letter-spacing:.08em;
      font-weight:800;
      text-transform:uppercase;
      font-size:clamp(18px,3vw,22px);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .title span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:3px 9px;
      border-radius:999px;
      background:radial-gradient(circle at 0 0,#38bdf8,#0ea5e9);
      color:#0b1120;
      font-size:14px;
      box-shadow:0 0 0 2px rgba(15,23,42,.94);
    }
    .subtitle{
      font-size:12px;
      text-transform:uppercase;
      color:var(--muted);
      letter-spacing:.16em;
    }
    .hud{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:radial-gradient(circle at top,rgba(30,64,175,.9),rgba(15,23,42,.95));
      font-size:12px;
      min-width:90px;
      justify-content:center;
    }
    .pill-label{
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
      font-size:10px;
    }
    .pill-value{
      font-variant-numeric:tabular-nums;
      font-weight:600;
    }
    .pill.timer{
      background:radial-gradient(circle at top,rgba(248,113,113,.95),rgba(30,64,175,.96));
      border-color:rgba(248,113,113,.7);
    }

    .seed-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
      align-items:center;
      justify-content:space-between;
    }
    .seed-left{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .seed-input-wrap{
      display:flex;
      align-items:stretch;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(15,23,42,.9);
    }
    .seed-input-wrap input{
      border:none;
      outline:none;
      padding:7px 10px;
      font-size:12px;
      background:transparent;
      color:var(--bright);
      width:108px;
      text-transform:uppercase;
      font-variant-numeric:tabular-nums;
      letter-spacing:.1em;
    }
    .seed-input-wrap span{
      padding:7px 10px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
      border-left:1px solid rgba(55,65,81,.9);
    }
    .btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-family:inherit;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      transition:transform .08s ease, box-shadow .08s ease, background .12s ease;
      background:linear-gradient(135deg,#38bdf8,#0ea5e9);
      color:#0b1120;
      box-shadow:0 10px 25px rgba(56,189,248,.45);
    }
    .btn.secondary{
      background:rgba(15,23,42,1);
      color:var(--bright);
      border:1px solid rgba(148,163,184,.7);
      box-shadow:0 10px 25px rgba(15,23,42,.9);
    }
    .btn:active{
      transform:translateY(1px) scale(.98);
      box-shadow:0 4px 12px rgba(15,23,42,.8);
    }

    .board-wrap{
      background:radial-gradient(circle at top,rgba(15,23,42,1),rgba(2,6,23,1));
      border-radius:var(--radius);
      padding:10px;
      border:1px solid rgba(30,64,175,.9);
      box-shadow:0 15px 40px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .board{
      display:grid;
      grid-template-columns:repeat(15, 1fr);
      gap:2px;
      touch-action:manipulation;
      user-select:none;
    }
    .cell{
      position:relative;
      border:none;
      outline:none;
      background:radial-gradient(circle at 20% 0%,rgba(15,23,42,1),rgba(15,23,42,.95));
      border-radius:6px;
      aspect-ratio:1/1;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:clamp(12px,1.7vw,18px);
      color:var(--bright);
      box-shadow:inset 0 0 0 1px rgba(148,163,184,.45);
      transition:background .08s ease, transform .05s ease, box-shadow .08s ease, color .12s ease;
      -webkit-tap-highlight-color:transparent;
    }
    .cell.unrevealed::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:linear-gradient(145deg,rgba(248,250,252,.06),transparent 55%);
      opacity:.9;
      pointer-events:none;
    }
    .cell.unrevealed:active{
      transform:translateY(1px) scale(.98);
      box-shadow:inset 0 0 0 1px rgba(148,163,184,.85);
    }
    .cell.revealed{
      cursor:default;
      box-shadow:inset 0 0 0 1px rgba(15,23,42,.9);
      background:radial-gradient(circle at 30% 0%,rgba(30,64,175,.9),rgba(15,23,42,1));
    }
    .cell.mine{
      background:radial-gradient(circle at 20% 0%,rgba(248,113,113,1),rgba(127,29,29,1));
      box-shadow:inset 0 0 0 1px rgba(254,226,226,.9);
      color:#020617;
      font-weight:800;
    }
    .cell.flagged{
      box-shadow:inset 0 0 0 1px rgba(250,204,21,.85);
    }
    .cell .num{
      font-weight:800;
      letter-spacing:.02em;
    }

    .legend-card{
      background:var(--card);
      border-radius:var(--radius);
      padding:10px 11px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 15px 32px rgba(15,23,42,.88);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
    }
    .legend-title{
      text-transform:uppercase;
      font-size:11px;
      letter-spacing:.18em;
      color:var(--muted);
    }
    .legend-list{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px 10px;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .legend-emoji{
      width:22px;
      height:22px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:15px;
      background:radial-gradient(circle at 30% 0,rgba(248,250,252,.95),rgba(30,64,175,.9));
      box-shadow:0 0 0 1px rgba(148,163,184,.7);
    }
    .legend-text{ display:flex; flex-direction:column; gap:2px; }
    .legend-name{ font-weight:600; font-size:12px; }
    .legend-desc{ font-size:11px; color:var(--muted); }

    .hint{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
      margin-top:4px;
    }

    .message{
      margin-top:8px;
      font-size:12px;
      min-height:16px;
      color:var(--muted);
    }
    .message strong{ color:var(--gold); }

    .badge-row{
      display:flex;
      gap:5px;
      margin-top:2px;
      flex-wrap:wrap;
    }
    .badge{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      color:var(--muted);
      background:rgba(15,23,42,.8);
    }

    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      opacity:0;
      transition:opacity .2s ease;
    }
    .overlay.visible{
      opacity:1;
      pointer-events:auto;
    }
    .overlay-backdrop{
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 50% 0%,rgba(15,23,42,.1),rgba(15,23,42,.95));
      backdrop-filter:blur(3px);
    }
    .overlay-card{
      position:relative;
      z-index:1;
      background:rgba(15,23,42,.98);
      border-radius:20px;
      padding:14px 16px;
      border:1px solid rgba(248,250,252,.18);
      max-width:300px;
      width:88%;
      text-align:center;
      box-shadow:0 20px 50px rgba(0,0,0,.85);
      font-size:13px;
    }
    .overlay-title{
      font-weight:800;
      margin-bottom:6px;
      font-size:14px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .overlay-body{
      color:var(--muted);
      line-height:1.5;
      margin-bottom:10px;
    }
    .overlay-body span{
      color:var(--gold);
      font-weight:700;
    }
    .overlay-seed{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .overlay-seed-code{
      display:inline-block;
      margin-top:3px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,1);
      border:1px dashed rgba(148,163,184,.8);
      font-variant-numeric:tabular-nums;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--bright);
    }
    .overlay-actions{
      display:flex;
      justify-content:center;
      gap:8px;
      margin-top:6px;
    }
  </style>
</head>
<body>
<div class="game-shell">
  <div class="content">
    <div class="left">
      <header class="header">
        <div class="title-block">
          <div class="title">
            <span class="logo">MS</span>
            Minesweeper
          </div>
          <div class="subtitle">seeded classic minesweeper</div>
        </div>
        <div class="hud">
          <div class="pill timer">
            <div class="pill-label">Time</div>
            <div class="pill-value" id="timeValue">00s</div>
          </div>
          <div class="pill">
            <div class="pill-label">Flags</div>
            <div class="pill-value" id="flagsValue">0</div>
          </div>
          <div class="pill">
            <div class="pill-label">Mines</div>
            <div class="pill-value" id="minesValue">0</div>
          </div>
        </div>
      </header>

      <div class="seed-row">
        <div class="seed-left">
          <div class="seed-input-wrap">
            <input id="seedInput" autocomplete="off" />
            <span>Map Code</span>
          </div>
          <button class="btn secondary" id="useSeedBtn">Use Code</button>
          <button class="btn secondary" id="randomMapBtn">New Map</button>
        </div>
        <button class="btn" id="restartBtn">Restart</button>
      </div>

      <div class="board-wrap">
        <div id="board" class="board"></div>

        <div class="overlay" id="overlay">
          <div class="overlay-backdrop"></div>
          <div class="overlay-card">
            <div class="overlay-title" id="overlayTitle">Game Over</div>
            <div class="overlay-body">
              Result: <span id="overlayResult">Lost</span><br/>
              Time: <span id="overlayTime">00s</span>
              <div class="overlay-seed">
                Map code:
                <div class="overlay-seed-code" id="overlaySeedCode">ABC123</div>
              </div>
            </div>
            <div class="overlay-actions">
              <button class="btn secondary" id="overlayCloseBtn">Close</button>
            </div>
          </div>
        </div>

      </div>

      <div class="message" id="message">
        Left click to reveal. Right click (or long-press) to flag üö©. Same map code = same mine layout.
      </div>
    </div>

    <aside class="right">
      <div class="legend-card">
        <div class="legend-title">Legend</div>
        <div class="legend-list">
          <div class="legend-item">
            <div class="legend-emoji">üñ±Ô∏è</div>
            <div class="legend-text">
              <div class="legend-name">Reveal</div>
              <div class="legend-desc">Left click</div>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-emoji">üö©</div>
            <div class="legend-text">
              <div class="legend-name">Flag</div>
              <div class="legend-desc">Right click / long-press</div>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-emoji">üí£</div>
            <div class="legend-text">
              <div class="legend-name">Mine</div>
              <div class="legend-desc">Don‚Äôt click it</div>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-emoji">üî¢</div>
            <div class="legend-text">
              <div class="legend-name">Number</div>
              <div class="legend-desc">Mines touching</div>
            </div>
          </div>
        </div>
        <div class="badge-row">
          <div class="badge">15 √ó 15 Board</div>
          <div class="badge" id="badgeMines">Mines: 40</div>
          <div class="badge">Seeded Maps</div>
        </div>
        <div class="hint">
          <strong>Tip:</strong> If a cell shows ‚Äú3‚Äù, exactly <em>three</em> mines touch it (8 neighbors). Use flags to mark mines.
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  // ---- Config ----
  const BOARD_SIZE = 15;
  const MINES_COUNT = 40; // classic-ish density for 15x15
  const boardEl = document.getElementById('board');

  // HUD
  const timeValueEl = document.getElementById('timeValue');
  const flagsValueEl = document.getElementById('flagsValue');
  const minesValueEl = document.getElementById('minesValue');
  const badgeMinesEl = document.getElementById('badgeMines');
  const messageEl = document.getElementById('message');

  // Seed controls
  const seedInputEl = document.getElementById('seedInput');
  const useSeedBtn = document.getElementById('useSeedBtn');
  const randomMapBtn = document.getElementById('randomMapBtn');
  const restartBtn = document.getElementById('restartBtn');

  // Overlay
  const overlayEl = document.getElementById('overlay');
  const overlayTitleEl = document.getElementById('overlayTitle');
  const overlayResultEl = document.getElementById('overlayResult');
  const overlayTimeEl = document.getElementById('overlayTime');
  const overlaySeedCodeEl = document.getElementById('overlaySeedCode');
  const overlayCloseBtn = document.getElementById('overlayCloseBtn');

  // ---- State ----
  let board = []; // {mine:boolean, revealed:boolean, flagged:boolean, num:int}
  let gameState = 'idle'; // idle | running | over
  let flagsUsed = 0;
  let revealedSafe = 0;
  let currentSeed = '';
  let timerId = null;
  let startMs = 0;

  // ---- Helpers ----
  function padTime(sec){ return (sec < 10 ? '0' : '') + sec + 's'; }

  function randomSeed(){
    return Math.random().toString(36).substring(2,8).toUpperCase();
  }

  // xmur3 & mulberry32 for seeded RNG (kept from your code)
  function xmur3(str){
    let h = 1779033703 ^ str.length;
    for(let i=0;i<str.length;i++){
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = h << 13 | h >>> 19;
    }
    return function(){
      h = Math.imul(h ^ (h >>> 16), 2246822507);
      h = Math.imul(h ^ (h >>> 13), 3266489909);
      h ^= h >>> 16;
      return h >>> 0;
    }
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }
  function makeRngFromSeed(seedStr){
    const seedGen = xmur3(seedStr);
    const seed = seedGen();
    return mulberry32(seed);
  }

  function idx(r,c){ return r * BOARD_SIZE + c; }

  function inBounds(r,c){
    return r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE;
  }

  function neighbors(r,c){
    const out = [];
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        if(dr===0 && dc===0) continue;
        const rr = r+dr, cc = c+dc;
        if(inBounds(rr,cc)) out.push([rr,cc]);
      }
    }
    return out;
  }

  function updateHUD(){
    minesValueEl.textContent = MINES_COUNT;
    badgeMinesEl.textContent = 'Mines: ' + MINES_COUNT;
    flagsValueEl.textContent = flagsUsed;

    if(gameState === 'running'){
      const sec = Math.floor((Date.now() - startMs)/1000);
      timeValueEl.textContent = padTime(sec);
    } else if(gameState === 'idle') {
      timeValueEl.textContent = padTime(0);
    }
  }

  function showOverlay(title, result){
    overlayTitleEl.textContent = title;
    overlayResultEl.textContent = result;
    const sec = (gameState === 'running' || gameState === 'over')
      ? Math.floor((Date.now() - startMs)/1000)
      : 0;
    overlayTimeEl.textContent = padTime(sec);
    overlaySeedCodeEl.textContent = currentSeed.toUpperCase();
    overlayEl.classList.add('visible');
  }
  function hideOverlay(){ overlayEl.classList.remove('visible'); }

  function startTimerIfNeeded(){
    if(gameState !== 'idle') return;
    gameState = 'running';
    startMs = Date.now();
    timerId = setInterval(updateHUD, 250);
  }

  function stopTimer(){
    clearInterval(timerId);
    timerId = null;
  }

  // ---- Game Gen ----
  function resetState(){
    gameState = 'idle';
    flagsUsed = 0;
    revealedSafe = 0;
    stopTimer();
    updateHUD();
    hideOverlay();
    messageEl.innerHTML = 'Left click to reveal. Right click (or long-press) to flag üö©. Same map code = same mine layout.';
  }

  function buildDom(){
    boardEl.innerHTML = '';
    for(let r=0;r<BOARD_SIZE;r++){
      for(let c=0;c<BOARD_SIZE;c++){
        const btn = document.createElement('button');
        btn.className = 'cell unrevealed';
        btn.setAttribute('data-r', r);
        btn.setAttribute('data-c', c);

        // left click
        btn.addEventListener('click', onReveal, {passive:false});

        // right click (desktop)
        btn.addEventListener('contextmenu', (e)=>{
          e.preventDefault();
          onFlag(e);
        });

        // long press (mobile)
        let pressTimer = null;
        btn.addEventListener('pointerdown', (e)=>{
          if(e.pointerType === 'mouse') return;
          pressTimer = setTimeout(()=>{
            onFlag(e);
          }, 450);
        });
        btn.addEventListener('pointerup', ()=> clearTimeout(pressTimer));
        btn.addEventListener('pointercancel', ()=> clearTimeout(pressTimer));
        btn.addEventListener('pointerleave', ()=> clearTimeout(pressTimer));

        boardEl.appendChild(btn);
      }
    }
  }

  function generateBoard(seedStr){
    currentSeed = (seedStr || randomSeed()).toUpperCase();
    seedInputEl.value = currentSeed;
    const rng = makeRngFromSeed(currentSeed);

    // Create cells
    board = [];
    for(let i=0;i<BOARD_SIZE*BOARD_SIZE;i++){
      board.push({ mine:false, revealed:false, flagged:false, num:0 });
    }

    // Place mines via shuffled indices
    const positions = [];
    for(let i=0;i<BOARD_SIZE*BOARD_SIZE;i++) positions.push(i);
    for(let i=positions.length-1;i>0;i--){
      const j = Math.floor(rng() * (i+1));
      [positions[i], positions[j]] = [positions[j], positions[i]];
    }
    for(let i=0;i<MINES_COUNT;i++){
      board[positions[i]].mine = true;
    }

    // Compute numbers
    for(let r=0;r<BOARD_SIZE;r++){
      for(let c=0;c<BOARD_SIZE;c++){
        const cell = board[idx(r,c)];
        if(cell.mine){ cell.num = -1; continue; }
        let count = 0;
        for(const [rr,cc] of neighbors(r,c)){
          if(board[idx(rr,cc)].mine) count++;
        }
        cell.num = count;
      }
    }

    buildDom();
    resetState();
    updateHUD();
  }

  // ---- Rendering ----
  function setButtonText(el, text){
    el.textContent = '';
    if(text === '') return;
    const span = document.createElement('span');
    span.className = 'num';
    span.textContent = text;
    el.appendChild(span);
  }

  function renderCell(r,c){
    const cell = board[idx(r,c)];
    const el = boardEl.children[idx(r,c)];

    el.classList.toggle('revealed', cell.revealed);
    el.classList.toggle('unrevealed', !cell.revealed);
    el.classList.toggle('flagged', cell.flagged);

    if(!cell.revealed){
      // show flag if flagged
      el.textContent = cell.flagged ? 'üö©' : '';
      return;
    }

    // revealed:
    if(cell.mine){
      el.classList.add('mine');
      el.textContent = 'üí£';
      return;
    }

    el.classList.remove('mine');
    if(cell.num > 0){
      setButtonText(el, String(cell.num));
    } else {
      el.textContent = '';
    }
  }

  function revealAllMines(){
    for(let r=0;r<BOARD_SIZE;r++){
      for(let c=0;c<BOARD_SIZE;c++){
        const cell = board[idx(r,c)];
        if(cell.mine){
          cell.revealed = true;
          cell.flagged = false;
          renderCell(r,c);
        }
      }
    }
  }

  function endGame(win){
    if(gameState === 'over') return;
    gameState = 'over';
    stopTimer();
    updateHUD();

    if(win){
      messageEl.innerHTML = '<strong>You win!</strong> All safe tiles revealed.';
      showOverlay('Victory', 'Won');
    }else{
      messageEl.innerHTML = '<strong>Game over.</strong> You clicked a mine.';
      showOverlay('Game Over', 'Lost');
    }
  }

  function checkWin(){
    const safeTotal = BOARD_SIZE*BOARD_SIZE - MINES_COUNT;
    if(revealedSafe >= safeTotal){
      endGame(true);
    }
  }

  // Flood fill for zeros
  function floodReveal(startR, startC){
    const stack = [[startR, startC]];
    while(stack.length){
      const [r,c] = stack.pop();
      const cell = board[idx(r,c)];
      if(cell.revealed || cell.flagged) continue;
      if(cell.mine) continue;

      cell.revealed = true;
      revealedSafe++;
      renderCell(r,c);

      if(cell.num === 0){
        for(const [rr,cc] of neighbors(r,c)){
          const ncell = board[idx(rr,cc)];
          if(!ncell.revealed && !ncell.mine && !ncell.flagged){
            stack.push([rr,cc]);
          }
        }
      }
    }
  }

  // ---- Input handlers ----
  function onReveal(e){
    if(gameState === 'over') return;
    const target = e.currentTarget;
    const r = parseInt(target.getAttribute('data-r'),10);
    const c = parseInt(target.getAttribute('data-c'),10);
    const cell = board[idx(r,c)];

    if(cell.revealed || cell.flagged) return;

    startTimerIfNeeded();

    if(cell.mine){
      cell.revealed = true;
      renderCell(r,c);
      revealAllMines();
      endGame(false);
      return;
    }

    // reveal
    if(cell.num === 0){
      floodReveal(r,c);
    } else {
      cell.revealed = true;
      revealedSafe++;
      renderCell(r,c);
    }

    checkWin();
  }

  function onFlag(e){
    if(gameState === 'over') return;
    const target = e.currentTarget || e.target;
    if(!target || !target.classList.contains('cell')) return;

    const r = parseInt(target.getAttribute('data-r'),10);
    const c = parseInt(target.getAttribute('data-c'),10);
    const cell = board[idx(r,c)];
    if(cell.revealed) return;

    startTimerIfNeeded();

    cell.flagged = !cell.flagged;
    flagsUsed += cell.flagged ? 1 : -1;
    if(flagsUsed < 0) flagsUsed = 0;
    renderCell(r,c);
    updateHUD();
  }

  // ---- UI buttons ----
  useSeedBtn.addEventListener('click', ()=>{
    const value = (seedInputEl.value || '').trim().toUpperCase();
    if(!value){
      messageEl.innerHTML = 'Enter a map code (e.g., <strong>'+randomSeed()+'</strong>) or tap <strong>New Map</strong>.';
      return;
    }
    generateBoard(value);
    messageEl.innerHTML = 'Map loaded. Start by revealing a tile.';
  });

  randomMapBtn.addEventListener('click', ()=>{
    generateBoard(randomSeed());
    messageEl.innerHTML = 'New map ready. Share the code <strong>'+currentSeed+'</strong> with your friend.';
  });

  restartBtn.addEventListener('click', ()=>{
    generateBoard(currentSeed);
    messageEl.innerHTML = 'Same map, fresh start.';
  });

  overlayCloseBtn.addEventListener('click', hideOverlay);

  // ---- Start ----
  generateBoard(randomSeed());
})();
</script>
</body>
</html>
