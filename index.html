<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Minesweeper + Treasures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg:#050816;
      --bg2:#0b1220;
      --card:rgba(15,23,42,.96);
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.16);
      --accent-2:#f97316;
      --accent-3:#22c55e;
      --bright:#e5e7eb;
      --muted:#9ca3af;
      --danger:#fb7185;
      --gold:#facc15;
      --shadow:0 24px 60px rgba(0,0,0,.7);
      --radius:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top,#0f172a 0,#020617 55%,#000 100%);
      color:var(--bright);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
    }
    .game-shell{
      width:100%;
      max-width:980px;
      background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.92));
      border-radius:24px;
      padding:14px 14px 18px;
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.45);
      position:relative;
      overflow:hidden;
    }
    .game-shell::before{
      content:"";
      position:absolute;
      inset:-120px;
      background:
        radial-gradient(circle at 0% 0%,rgba(56,189,248,.12),transparent 55%),
        radial-gradient(circle at 100% 0%,rgba(249,115,22,.12),transparent 55%);
      pointer-events:none;
      opacity:.7;
    }
    .content{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns:minmax(0,1.5fr) minmax(0,1fr);
      gap:14px;
    }
    @media (max-width:860px){
      .content{ grid-template-columns:1fr; }
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .title-block{ display:flex; flex-direction:column; gap:2px; }
    .title{
      letter-spacing:.08em;
      font-weight:800;
      text-transform:uppercase;
      font-size:clamp(18px,3vw,22px);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .title span.logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:3px 9px;
      border-radius:999px;
      background:radial-gradient(circle at 0 0,#38bdf8,#0ea5e9);
      color:#0b1120;
      font-size:14px;
      box-shadow:0 0 0 2px rgba(15,23,42,.94);
    }
    .subtitle{
      font-size:12px;
      text-transform:uppercase;
      color:var(--muted);
      letter-spacing:.16em;
    }

    .hud{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:flex-start;
      max-width:520px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:radial-gradient(circle at top,rgba(30,64,175,.9),rgba(15,23,42,.95));
      font-size:12px;
      min-width:88px;
      justify-content:center;
      user-select:none;
    }
    .pill-label{
      text-transform:uppercase;
      letter-spacing:.1em;
      color:var(--muted);
      font-size:10px;
    }
    .pill-value{
      font-variant-numeric:tabular-nums;
      font-weight:700;
    }
    .pill.timer{
      background:radial-gradient(circle at top,rgba(248,113,113,.95),rgba(30,64,175,.96));
      border-color:rgba(248,113,113,.7);
    }
    .pill.treasure{
      border-color:rgba(250,204,21,.55);
      background:radial-gradient(circle at top,rgba(250,204,21,.18),rgba(15,23,42,.95));
    }

    .seed-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
      align-items:center;
      justify-content:space-between;
    }
    .seed-left{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .seed-input-wrap{
      display:flex;
      align-items:stretch;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(15,23,42,.9);
    }
    .seed-input-wrap input{
      border:none;
      outline:none;
      padding:7px 10px;
      font-size:12px;
      background:transparent;
      color:var(--bright);
      width:108px;
      text-transform:uppercase;
      font-variant-numeric:tabular-nums;
      letter-spacing:.1em;
    }
    .seed-input-wrap span{
      padding:7px 10px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
      border-left:1px solid rgba(55,65,81,.9);
    }
    .btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-family:inherit;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      transition:transform .08s ease, box-shadow .08s ease, background .12s ease, opacity .12s ease;
      background:linear-gradient(135deg,#38bdf8,#0ea5e9);
      color:#0b1120;
      box-shadow:0 10px 25px rgba(56,189,248,.45);
      user-select:none;
    }
    .btn.secondary{
      background:rgba(15,23,42,1);
      color:var(--bright);
      border:1px solid rgba(148,163,184,.7);
      box-shadow:0 10px 25px rgba(15,23,42,.9);
    }
    .btn:active{
      transform:translateY(1px) scale(.98);
      box-shadow:0 4px 12px rgba(15,23,42,.8);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .board-wrap{
      background:radial-gradient(circle at top,rgba(15,23,42,1),rgba(2,6,23,1));
      border-radius:var(--radius);
      padding:10px;
      border:1px solid rgba(30,64,175,.9);
      box-shadow:0 15px 40px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .board{
      display:grid;
      grid-template-columns:repeat(15, 1fr);
      gap:2px;
      touch-action:manipulation;
      user-select:none;
    }

    /* prevent resizing/jumps */
    .cell{
      position:relative;
      border:0;
      outline:none;
      padding:0;
      line-height:1;
      min-width:0;
      min-height:0;
      background:radial-gradient(circle at 20% 0%,rgba(15,23,42,1),rgba(15,23,42,.95));
      border-radius:6px;
      aspect-ratio:1/1;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:clamp(12px,1.7vw,18px);
      color:var(--bright);
      box-shadow:inset 0 0 0 1px rgba(148,163,184,.45);
      transition:background .08s ease, transform .05s ease, box-shadow .08s ease, color .12s ease, filter .12s ease;
      -webkit-tap-highlight-color:transparent;
      box-sizing:border-box;
    }
    .cell:focus,
    .cell:focus-visible{ outline:none; }
    .cell:focus-visible{
      box-shadow:
        inset 0 0 0 1px rgba(148,163,184,.65),
        0 0 0 2px rgba(56,189,248,.35);
    }

    .cell.unrevealed::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:linear-gradient(145deg,rgba(248,250,252,.06),transparent 55%);
      opacity:.9;
      pointer-events:none;
    }
    .cell.unrevealed:active{
      transform:translateY(1px) scale(.98);
      box-shadow:inset 0 0 0 1px rgba(148,163,184,.85);
    }
    .cell.revealed{
      cursor:default;
      background:radial-gradient(circle at 30% 0%,rgba(30,64,175,.9),rgba(15,23,42,1));
      box-shadow:inset 0 0 0 1px rgba(15,23,42,.9);
    }
    .cell.mine{
      background:radial-gradient(circle at 20% 0%,rgba(248,113,113,1),rgba(127,29,29,1));
      box-shadow:inset 0 0 0 1px rgba(254,226,226,.9);
      color:#020617;
      font-weight:900;
    }
    .cell.flagged{
      box-shadow:inset 0 0 0 1px rgba(250,204,21,.85);
    }
    .cell .num{
      font-weight:900;
      letter-spacing:.02em;
    }

    /* Scan peek effect */
    .cell.scan-peek{
      filter:brightness(1.18);
      box-shadow:
        inset 0 0 0 1px rgba(250,204,21,.55),
        0 0 0 2px rgba(250,204,21,.18);
    }

    .message{
      margin-top:8px;
      font-size:12px;
      min-height:16px;
      color:var(--muted);
    }
    .message strong{ color:var(--gold); }

    .legend-card{
      background:var(--card);
      border-radius:var(--radius);
      padding:10px 11px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 15px 32px rgba(15,23,42,.88);
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:12px;
    }
    .legend-title{
      text-transform:uppercase;
      font-size:11px;
      letter-spacing:.18em;
      color:var(--muted);
    }
    .legend-list{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px 10px;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .legend-emoji{
      width:22px;
      height:22px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:15px;
      background:radial-gradient(circle at 30% 0,rgba(248,250,252,.95),rgba(30,64,175,.9));
      box-shadow:0 0 0 1px rgba(148,163,184,.7);
    }
    .legend-text{ display:flex; flex-direction:column; gap:2px; }
    .legend-name{ font-weight:700; font-size:12px; }
    .legend-desc{ font-size:11px; color:var(--muted); }

    .badge-row{
      display:flex;
      gap:5px;
      flex-wrap:wrap;
    }
    .badge{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      color:var(--muted);
      background:rgba(15,23,42,.8);
    }

    .hint{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      opacity:0;
      transition:opacity .2s ease;
    }
    .overlay.visible{
      opacity:1;
      pointer-events:auto;
    }
    .overlay-backdrop{
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 50% 0%,rgba(15,23,42,.1),rgba(15,23,42,.95));
      backdrop-filter:blur(3px);
    }
    .overlay-card{
      position:relative;
      z-index:1;
      background:rgba(15,23,42,.98);
      border-radius:20px;
      padding:14px 16px;
      border:1px solid rgba(248,250,252,.18);
      max-width:320px;
      width:88%;
      text-align:center;
      box-shadow:0 20px 50px rgba(0,0,0,.85);
      font-size:13px;
    }
    .overlay-title{
      font-weight:900;
      margin-bottom:6px;
      font-size:14px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .overlay-body{
      color:var(--muted);
      line-height:1.5;
      margin-bottom:10px;
    }
    .overlay-body span{
      color:var(--gold);
      font-weight:800;
    }
    .overlay-seed{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .overlay-seed-code{
      display:inline-block;
      margin-top:3px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(15,23,42,1);
      border:1px dashed rgba(148,163,184,.8);
      font-variant-numeric:tabular-nums;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--bright);
    }
    .overlay-actions{
      display:flex;
      justify-content:center;
      gap:8px;
      margin-top:6px;
    }
  </style>
</head>
<body>
<div class="game-shell">
  <div class="content">
    <div class="left">
      <header class="header">
        <div class="title-block">
          <div class="title">
            <span class="logo">MS</span>
            Minesweeper
          </div>
          <div class="subtitle">treasures drop from number tiles (5%)</div>
        </div>

        <div class="hud">
          <div class="pill timer">
            <div class="pill-label">Time</div>
            <div class="pill-value" id="timeValue">00s</div>
          </div>
          <div class="pill">
            <div class="pill-label">Flags</div>
            <div class="pill-value" id="flagsValue">0</div>
          </div>
          <div class="pill">
            <div class="pill-label">Mines</div>
            <div class="pill-value" id="minesValue">0</div>
          </div>

          <div class="pill treasure" title="Defuse removes one random unrevealed mine">
            <div class="pill-label">üßØ</div>
            <div class="pill-value" id="defuseValue">0</div>
          </div>
          <div class="pill treasure" title="Scan lets you peek a 3√ó3 area (temporary)">
            <div class="pill-label">üîç</div>
            <div class="pill-value" id="scanValue">0</div>
          </div>
          <div class="pill treasure" title="Shield saves you from one mine click">
            <div class="pill-label">üõ°Ô∏è</div>
            <div class="pill-value" id="shieldValue">0</div>
          </div>
        </div>
      </header>

      <div class="seed-row">
        <div class="seed-left">
          <div class="seed-input-wrap">
            <input id="seedInput" autocomplete="off" />
            <span>Map Code</span>
          </div>
          <button class="btn secondary" id="useSeedBtn">Use Code</button>
          <button class="btn secondary" id="randomMapBtn">New Map</button>
        </div>

        <div class="seed-left">
          <button class="btn secondary" id="defuseBtn" title="Use one Defuse">Use üßØ</button>
          <button class="btn secondary" id="scanBtn" title="Use one Scan, then click a tile">Use üîç</button>
          <button class="btn" id="restartBtn">Restart</button>
        </div>
      </div>

      <div class="board-wrap">
        <div id="board" class="board"></div>

        <div class="overlay" id="overlay">
          <div class="overlay-backdrop"></div>
          <div class="overlay-card">
            <div class="overlay-title" id="overlayTitle">Game Over</div>
            <div class="overlay-body">
              Result: <span id="overlayResult">Lost</span><br/>
              Time: <span id="overlayTime">00s</span>
              <div class="overlay-seed">
                Map code:
                <div class="overlay-seed-code" id="overlaySeedCode">ABC123</div>
              </div>
            </div>
            <div class="overlay-actions">
              <button class="btn secondary" id="overlayCloseBtn">Close</button>
            </div>
          </div>
        </div>
      </div>

      <div class="message" id="message">
        Left click to reveal. Right click / long-press to flag üö©. Click revealed number tiles for a 5% treasure drop.
      </div>
    </div>

    <aside class="right">
      <div class="legend-card">
        <div class="legend-title">Legend</div>
        <div class="legend-list">
          <div class="legend-item">
            <div class="legend-emoji">üñ±Ô∏è</div>
            <div class="legend-text">
              <div class="legend-name">Reveal</div>
              <div class="legend-desc">Left click</div>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-emoji">üö©</div>
            <div class="legend-text">
              <div class="legend-name">Flag</div>
              <div class="legend-desc">Right click / long-press</div>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-emoji">üí£</div>
            <div class="legend-text">
              <div class="legend-name">Mine</div>
              <div class="legend-desc">Don‚Äôt click it</div>
            </div>
          </div>
          <div class="legend-item">
            <div class="legend-emoji">üî¢</div>
            <div class="legend-text">
              <div class="legend-name">Number</div>
              <div class="legend-desc">Mines touching</div>
            </div>
          </div>
        </div>

        <div class="badge-row">
          <div class="badge">15 √ó 15 Board</div>
          <div class="badge" id="badgeMines">Mines: 40</div>
          <div class="badge">Treasures: 5%</div>
        </div>

        <div class="hint">
          <strong>Treasures:</strong><br/>
          üßØ Defuse removes one random unrevealed mine.<br/>
          üîç Scan lets you peek a 3√ó3 area for 1.5s.<br/>
          üõ°Ô∏è Shield saves you from one mine click (the mine is removed).
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  // ---- Config ----
  const BOARD_SIZE = 15;
  const MINES_START = 40;
  const TREASURE_CHANCE = 0.05; // 5% chance when clicking a revealed number tile

  const boardEl = document.getElementById('board');

  // HUD
  const timeValueEl = document.getElementById('timeValue');
  const flagsValueEl = document.getElementById('flagsValue');
  const minesValueEl = document.getElementById('minesValue');
  const badgeMinesEl = document.getElementById('badgeMines');
  const messageEl = document.getElementById('message');

  const defuseValueEl = document.getElementById('defuseValue');
  const scanValueEl = document.getElementById('scanValue');
  const shieldValueEl = document.getElementById('shieldValue');

  // Seed controls
  const seedInputEl = document.getElementById('seedInput');
  const useSeedBtn = document.getElementById('useSeedBtn');
  const randomMapBtn = document.getElementById('randomMapBtn');
  const restartBtn = document.getElementById('restartBtn');

  // Power buttons
  const defuseBtn = document.getElementById('defuseBtn');
  const scanBtn = document.getElementById('scanBtn');

  // Overlay
  const overlayEl = document.getElementById('overlay');
  const overlayTitleEl = document.getElementById('overlayTitle');
  const overlayResultEl = document.getElementById('overlayResult');
  const overlayTimeEl = document.getElementById('overlayTime');
  const overlaySeedCodeEl = document.getElementById('overlaySeedCode');
  const overlayCloseBtn = document.getElementById('overlayCloseBtn');

  // ---- State ----
  // cell: { mine, revealed, flagged, num, looted }
  let board = [];
  let gameState = 'idle'; // idle | running | over
  let flagsUsed = 0;
  let revealedSafe = 0;

  let currentSeed = '';
  let timerId = null;
  let startMs = 0;

  // power inventory
  let defuseCount = 0;
  let scanCount = 0;
  let shieldCount = 0;

  // dynamic mine count (can decrease with defuse/shield)
  let minesTotal = MINES_START;

  // scan mode
  let scanMode = false;
  let scanTimeoutId = null;

  // ---- Helpers ----
  function padTime(sec){ return (sec < 10 ? '0' : '') + sec + 's'; }
  function randomSeed(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

  // xmur3 & mulberry32 for seeded RNG
  function xmur3(str){
    let h = 1779033703 ^ str.length;
    for(let i=0;i<str.length;i++){
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = h << 13 | h >>> 19;
    }
    return function(){
      h = Math.imul(h ^ (h >>> 16), 2246822507);
      h = Math.imul(h ^ (h >>> 13), 3266489909);
      h ^= h >>> 16;
      return h >>> 0;
    }
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }
  function makeRngFromSeed(seedStr){
    const seedGen = xmur3(seedStr);
    const seed = seedGen();
    return mulberry32(seed);
  }

  function idx(r,c){ return r * BOARD_SIZE + c; }
  function inBounds(r,c){ return r >= 0 && r < BOARD_SIZE && c >= 0 && c < BOARD_SIZE; }

  function neighbors(r,c){
    const out = [];
    for(let dr=-1; dr<=1; dr++){
      for(let dc=-1; dc<=1; dc++){
        if(dr===0 && dc===0) continue;
        const rr = r+dr, cc = c+dc;
        if(inBounds(rr,cc)) out.push([rr,cc]);
      }
    }
    return out;
  }

  function updateHUD(){
    minesValueEl.textContent = minesTotal;
    badgeMinesEl.textContent = 'Mines: ' + minesTotal;
    flagsValueEl.textContent = flagsUsed;

    defuseValueEl.textContent = defuseCount;
    scanValueEl.textContent = scanCount;
    shieldValueEl.textContent = shieldCount;

    defuseBtn.disabled = (defuseCount <= 0) || (gameState === 'over');
    scanBtn.disabled = (scanCount <= 0) || (gameState === 'over') || scanMode;

    if(gameState === 'running'){
      const sec = Math.floor((Date.now() - startMs)/1000);
      timeValueEl.textContent = padTime(sec);
    } else if(gameState === 'idle') {
      timeValueEl.textContent = padTime(0);
    }
  }

  function showOverlay(title, result){
    overlayTitleEl.textContent = title;
    overlayResultEl.textContent = result;
    const sec = (gameState === 'running' || gameState === 'over')
      ? Math.floor((Date.now() - startMs)/1000)
      : 0;
    overlayTimeEl.textContent = padTime(sec);
    overlaySeedCodeEl.textContent = currentSeed.toUpperCase();
    overlayEl.classList.add('visible');
  }
  function hideOverlay(){ overlayEl.classList.remove('visible'); }

  function startTimerIfNeeded(){
    if(gameState !== 'idle') return;
    gameState = 'running';
    startMs = Date.now();
    timerId = setInterval(updateHUD, 250);
  }

  function stopTimer(){
    clearInterval(timerId);
    timerId = null;
  }

  function clearScanPeek(){
    if(scanTimeoutId) clearTimeout(scanTimeoutId);
    scanTimeoutId = null;
    for(let r=0;r<BOARD_SIZE;r++){
      for(let c=0;c<BOARD
